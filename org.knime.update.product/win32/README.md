# Custom KNIME executable

We replace the `knime.exe` generated by tycho with a customized one that is
signed by us and has a our custom manifest file attached to it. This manifest
file is needed to override the application name and the DPI settings.  Because
we are customizing the executable by replacing the default icons, we need to
re-sign it with our certificate.

## How to update the executable

We need to update the launcher executable when we update the Eclipse version
KNIME AP is based on, or we want to change the application manifest.

### Prerequisites

You need access to a windows machine or VM to run the commands on.
to have access to the following tools and files

- `osslsigncode` <https://github.com/mtrojnar/osslsigncode>
- `CODE_SIGNING_KEY_ID` found in DEVOPS AWS secret manager <https://eu-west-1.console.aws.amazon.com/secretsmanager/secret?name=jenkins%2Fcode-signing-key-id&region=eu-west-1>
- `knime-code-signing.pem` found in `jenkins-pipeline-libraries/resources/knime-code-signing.pem`
- `jsign.jar` download from maven central repository <https://repo1.maven.org/maven2/net/jsign/jsign/>

### Steps

1. Disable the `Fix Windows executable` execution in `org.knime.update.product/pom.xml` of by commenting out the `exec-maven-plugin`.
2. Run `mvn clean package -P local-build` in the `knime-product` folder, this will produce a build with unmodified launcher executable that we need to adapt in the next steps.
3. Copy the `knime.exe` from `org.knime.update.product/target/products/org.knime.desktop.product/win32/win32/x86_64/` to `org.knime.update.product/win32/` and then go to that folder.
4. Remove the signature from `knime.exe` by running `osslsigncode remove-signature -in knime.exe -out knime-stripped.exe`, then replace `knime.exe` with `knime-stripped.exe`.
5. Add the manifest to the executable by running `mt.exe -manifest knime.exe.manifest -outputresource:knime.exe;1`.
6. Sign the executable by running `java -jar <path/to/jsing.jar> --storetype AWS --keystore eu-west-1 --alias <CODE_SIGNING_KEY_ID> --certfile "<path/to/knime-code-signing.pem>" --tsaurl http://timestamp.sectigo.com --tsretries 3 --tsretrywait 5 --verbose knime.exe`
7. Move the signed executable to `org.knime.update.product/win32/x86_64/`, replacing the old one.
8. Re-enable the `Fix Windows executable` execution in `org.knime.update.product/pom.xml` of by uncommenting the `exec-maven-plugin`.
9. Run `mvn clean package -P local-build` in the `knime-product` folder, to create a build with our the modified launcher executable.
10. Test the build by running `knime.exe` from `org.knime.update.product/target/products/org.knime.desktop.product/win32/win32/x86_64/` and check that the application name is correct.
11. Verify the signature by running `osslsigncode verify org.knime.update.product/target/products/org.knime.desktop.product/win32/win32/x86_64/knime.exe`.
